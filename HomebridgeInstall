#!/bin/bash

# Author: Roman Schulz
# inspired by forum.smartapfel.de
# on GitHub: https://github.com/RomanSch/HomebridgeInstallScript
# Version 2.0.0

baseDir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd)"
homeDir=${HOME}
#defaultNodeVersion="9.11.2" #deprecated due to recommended NodeJS Installation
logPath="$baseDir/files/log/install.log"
pathToConfi="/var/lib/homebridge/config.json"

######################################
############# Functions ##############
######################################

log(){
	#Logging and output to console
	message=$1
	echo -e "$(date +%Y-%m-%d_%H-%M-%S) - $message" | sudo tee --append $logPath
	#sudo echo "$(date +%Y-%m-%d_%H-%M-%S) - $message" >> $logPath
}


if [ -e $baseDir/files/log ]; 
then 
        echo "Log folder already exists"
else 
	echo "Create Log folder in $baseDir/files/log"
        sudo mkdir $baseDir/files/log
	sudo chmod 0777 $baseDir/files/log
fi

######################################
######### Installationroutine ########     
######################################

##### Updating Homebridge Software
log "Starting Homebridge Installation"
log "Find the Installationlog at $logPath"
log "This Installationscript is not for Raspberry Pi 1 and Zero. \n If you are using a Raspberry Pi 1 or Zero please refer to the official Readme you can find here: \n https://github.com/homebridge/homebridge/wiki/Install-Homebridge-on-Raspbian"
log "Do you want to install Systemupdates first? It is recommended. (Y/N)"
read updSystem
if [ "$updSystem" == "y" -o "$updSystem" == "Y" ]
then
	log "Start Systemupdate"
	sudo apt-get update -y
	sudo apt-get dist-upgrade -y
	sudo apt-get check
	sudo apt-get clean
	log "!NOT RECOMMENDED! Do you want to update your Raspberry Firmware? !Restart required! (Y/N)"
	read firmwareUpdate
	if [ "$firmwareUpdate" == "Y" -o "$firmwareUpdate" == "y" ]
	then 
		log "Updating Raspberry Firmware - Restart is required after the update!"
		sudo rpi-update -y
	fi	
else
	log "Please update your Raspbian and other Software later."
fi
